{% extends "base.html" %}

{% block title %}Exercise History - Exercise Form Analyzer{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1>Your Exercise History</h1>
        <p>Track your progress and see how you've improved over time</p>
    </div>
    
    {% if history %}
    <div class="history-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-dumbbell"></i>
            </div>
            <div class="stat-content">
                <span class="stat-number">{{ history|length }}</span>
                <span class="stat-label">Total Workouts</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <span class="stat-number">{{ "%.1f"|format(history|map(attribute='accuracy')|list|sum / history|length) }}%</span>
                <span class="stat-label">Average Accuracy</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-content">
                <span class="stat-number">{{ history|map(attribute='accuracy')|list|max }}%</span>
                <span class="stat-label">Best Performance</span>
            </div>
        </div>
    </div>
    
    <div class="history-filters">
        <div class="filter-group">
            <label for="exercise-filter">Exercise Type:</label>
            <select id="exercise-filter" class="filter-select">
                <option value="">All Exercises</option>
                <option value="pushup">Push-ups</option>
                <option value="pullup">Pull-ups</option>
                <option value="plank">Plank</option>
                <option value="squat">Squats</option>
                <option value="tricep_dips">Tricep Dips</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="date-filter">Date Range:</label>
            <select id="date-filter" class="filter-select">
                <option value="">All Time</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>
        </div>
    </div>
    
    <div class="history-list">
        {% for exercise in history %}
        <div class="history-item" data-exercise="{{ exercise.exercise_type }}" data-date="{{ exercise.created_at.strftime('%Y-%m-%d') }}">
            <div class="exercise-info">
                <div class="exercise-icon">
                    {% if exercise.exercise_type == 'pushup' %}
                        <i class="fas fa-hand-paper"></i>
                    {% elif exercise.exercise_type == 'pullup' %}
                        <i class="fas fa-arrow-up"></i>
                    {% elif exercise.exercise_type == 'plank' %}
                        <i class="fas fa-minus"></i>
                    {% elif exercise.exercise_type == 'squat' %}
                        <i class="fas fa-arrow-down"></i>
                    {% elif exercise.exercise_type == 'tricep_dips' %}
                        <i class="fas fa-arrows-alt-v"></i>
                    {% endif %}
                </div>
                <div class="exercise-details">
                    <h3>{{ exercise.exercise_type.replace('_', ' ').title() }}</h3>
                    <p>{{ exercise.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                </div>
            </div>
            
            <div class="exercise-metrics">
                <div class="metric">
                    <span class="metric-label">Accuracy</span>
                    <span class="metric-value accuracy-{{ 'high' if exercise.accuracy >= 80 else 'medium' if exercise.accuracy >= 60 else 'low' }}">
                        {{ exercise.accuracy }}%
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Mistakes</span>
                    <span class="metric-value">{{ exercise.mistakes|length if exercise.mistakes else 0 }}</span>
                </div>
            </div>
            
            <div class="exercise-actions">
                <a href="{{ url_for('stream_video', filename=exercise.video_filename) }}" class="action-button" target="_blank">
                    <i class="fas fa-play"></i>
                    View Video
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-history">
        <div class="empty-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <h2>No Exercise History Yet</h2>
        <p>Start analyzing your workouts to build your fitness journey</p>
        <a href="{{ url_for('index') }}" class="cta-button">
            <i class="fas fa-dumbbell"></i>
            Start Your First Workout
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const exerciseFilter = document.getElementById('exercise-filter');
    const dateFilter = document.getElementById('date-filter');
    const historyItems = document.querySelectorAll('.history-item');
    
    function filterHistory() {
        const selectedExercise = exerciseFilter.value;
        const selectedDate = dateFilter.value;
        const now = new Date();
        
        historyItems.forEach(item => {
            let showItem = true;
            
            // Filter by exercise type
            if (selectedExercise && item.dataset.exercise !== selectedExercise) {
                showItem = false;
            }
            
            // Filter by date range
            if (selectedDate && showItem) {
                const itemDate = new Date(item.dataset.date);
                const daysDiff = Math.floor((now - itemDate) / (1000 * 60 * 60 * 24));
                
                switch (selectedDate) {
                    case 'week':
                        if (daysDiff > 7) showItem = false;
                        break;
                    case 'month':
                        if (daysDiff > 30) showItem = false;
                        break;
                    case 'year':
                        if (daysDiff > 365) showItem = false;
                        break;
                }
            }
            
            item.style.display = showItem ? 'flex' : 'none';
        });
    }
    
    exerciseFilter.addEventListener('change', filterHistory);
    dateFilter.addEventListener('change', filterHistory);
});
</script>
{% endblock %}
